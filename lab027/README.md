# Lab027 Масштабируемость и дизайн  BGP. 

# Исходное домашнее задание:
- внешний вид сети(рассматриваемый в данной лабе фрагмент):
![start](start.png)

## Поставленные задачи
1. Настроите iBGP в офисом Москва между маршрутизаторами R14 и R15.
2. Настроите iBGP в провайдере Триада, с использованием RR.
3. Настройте офиса Москва так, чтобы приоритетным провайдером стал Ламас.
4. Настройте офиса С.-Петербург так, чтобы трафик до любого офиса распределялся по двум линкам одновременно.
5. Все сети в лабораторной работе должны иметь IP связность.
6. План работы и изменения зафиксированы в документации.

### Выполнение задания
Стоит отметить, что часть операций я сделал в предыдущей лабораторной работе.
Но все же рассмотрю каждый пункт задания:
####  iBGP  между маршрутизаторами R14 и R15
На R14: 
```
router bgp 1001
 neighbor 10.0.1.15 remote-as 1001
 neighbor 10.0.1.15 update-source Loopback0
 neighbor 10.0.1.15 next-hop-self
```
тут мы устанавливаем соседство между R14 -> R15 посредство loo 0 интерфейса, а также 
подменяем next hop (иначе не взлетит).

Похожее делаем и на R15:
```
router bgp 1001
 neighbor 10.0.1.14 remote-as 1001
 neighbor 10.0.1.14 update-source Loopback0
 neighbor 10.0.1.14 next-hop-self
```
#### iBGP в провайдере Триада, с использованием RR

В предыдущей лабе  (lab025) в AS "Триады" я поднял OSPF и проанонсил туда всю внутреннюю сеть (чтобы была связность).  Поэтому сейчас можно сразу приступить к настройке iBGP и RR.
Я выбрал в качестве RR: роутер R23: 
```
router bgp 520
 bgp cluster-id 520
 network 10.5.2.0 mask 255.255.255.0
 neighbor RR-client peer-group
 neighbor RR-client remote-as 520
 neighbor RR-client update-source Loopback0
 neighbor RR-client route-reflector-client
 neighbor RR-client next-hop-self
 neighbor 10.5.2.24 peer-group RR-client
 neighbor 10.5.2.25 peer-group RR-client
 neighbor 10.5.2.26 peer-group RR-client
 neighbor 172.16.0.5 remote-as 101
 
 ip route 10.5.2.0 255.255.255.0 Null0
```
Ну и чтобы моя сетка управдения затянулась в bgp, добавил static route с поворотом в null.
Настройка R24:
```
router bgp 520
 neighbor 10.5.2.23 remote-as 520
 neighbor 10.5.2.23 update-source Loopback0
 neighbor 10.5.2.23 next-hop-self
 neighbor 172.16.0.17 remote-as 301
 neighbor 172.16.0.22 remote-as 2042
```
Тут мы устанавливаем соседство с внешними пирами, а также с RR роутером.

Настройка R25: 
```
router bgp 520
 network 10.5.2.0 mask 255.255.255.0
 neighbor 10.5.2.23 remote-as 520
 neighbor 10.5.2.23 update-source Loopback0
 neighbor 10.5.2.23 next-hop-self
```
настройка R26:
```
router bgp 520
 bgp router-id 10.5.2.26
 neighbor 10.5.2.23 remote-as 520
 neighbor 10.5.2.23 update-source Loopback0
 neighbor 10.5.2.23 next-hop-self
 neighbor 172.16.0.26 remote-as 2042
```
на этом настройка завершена. 
Смотрим, например, на маршруты на роутере R26:
```
Gateway of last resort is not set

      10.0.0.0/8 is variably subnetted, 16 subnets, 3 masks
B        10.0.1.0/24 [200/0] via 10.5.2.23, 00:00:44
B        10.0.2.0/24 [200/0] via 10.5.2.23, 00:00:44
B        10.1.0.22/32 [200/0] via 10.5.2.23, 00:00:44
B        10.3.0.21/32 [200/0] via 10.5.2.24, 00:00:44
B        10.20.42.0/24 [20/0] via 172.16.0.26, 00:00:44
      172.16.0.0/16 is variably subnetted, 6 subnets, 2 masks
B        172.16.0.4/30 [200/0] via 10.5.2.23, 00:00:44
B        172.16.0.8/30 [200/0] via 10.5.2.23, 00:00:44
B     192.168.1.0/24 [200/0] via 10.5.2.23, 00:00:44
B     192.168.42.0/24 [20/11] via 172.16.0.26, 00:00:44
```
Видим, что мы получаем все маршруты из офиса Москвы (которые анонсим),  маршруты из офиса Питера, а также Ламаса и Киторна. Связность - в порядке.
```
#ping 192.168.1.5
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 192.168.1.5, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/3 ms
```
Пинг с роутера R26 ПК - VPC1 (офис Москва)

#### Настройка офиса Москвы так, чтобы приоритетным провайдером стал Ламас

Для начала, смотрим как выглядит таблица маршрутов BGP:
```
 Network          Next Hop            Metric LocPrf Weight Path
 * i 10.0.1.0/24      10.0.1.15                0    100      0 i
 *>                   0.0.0.0                  0         32768 i
 * i 10.0.2.0/24      10.0.1.15                0    100      0 i
 *>                   0.0.0.0                  0         32768 i
 *>  10.1.0.22/32     172.16.0.2               0             0 101 i
 *   10.3.0.21/32     172.16.0.2                             0 101 301 i
 *>i                  10.0.1.15                0    100      0 301 i
 * i 10.5.2.0/24      10.0.1.15                0    100      0 301 520 i
 *>                   172.16.0.2                             0 101 520 i
 *>  10.20.42.0/24    172.16.0.2                             0 101 520 2042 i
 * i                  10.0.1.15                0    100      0 301 520 2042 i
 *>  172.16.0.4/30    172.16.0.2               0             0 101 i
 *>  172.16.0.8/30    172.16.0.2               0             0 101 i
 * i 192.168.1.0      10.0.1.15              311    100      0 i
     Network          Next Hop            Metric LocPrf Weight Path
 *>                   10.0.1.133             101         32768 i
 *>  192.168.42.0     172.16.0.2                             0 101 520 2042 i
 * i                  10.0.1.15                0    100      0 301 520 2042 i
```
Видим, что все внешний маршруты проходят через AS Киторн, что логично, т. к.  у нас прямая связность с этой AS.
Чтобы изменить это поведение на роутере R14 подниму вес соседа (в сторону R15):
```
router bgp 1001
  neighbor 10.0.1.15 weight 500
```
Затем (чтоб не ждать):
```
clear ip bgp * soft
```
Смотрим изменения:
```
     Network          Next Hop            Metric LocPrf Weight Path
 * i 10.0.1.0/24      10.0.1.15                0    100    500 i
 *>                   0.0.0.0                  0         32768 i
 * i 10.0.2.0/24      10.0.1.15                0    100    500 i
 *>                   0.0.0.0                  0         32768 i
 *>  10.1.0.22/32     172.16.0.2               0             0 101 i
 *   10.3.0.21/32     172.16.0.2                             0 101 301 i
 *>i                  10.0.1.15                0    100    500 301 i
 *>i 10.5.2.0/24      10.0.1.15                0    100    500 301 520 i
 *                    172.16.0.2                             0 101 520 i
 *   10.20.42.0/24    172.16.0.2                             0 101 520 2042 i
 *>i                  10.0.1.15                0    100    500 301 520 2042 i
 *>  172.16.0.4/30    172.16.0.2               0             0 101 i
 *>  172.16.0.8/30    172.16.0.2               0             0 101 i
 * i 192.168.1.0      10.0.1.15              311    100    500 i
     Network          Next Hop            Metric LocPrf Weight Path
 *>                   10.0.1.133             101         32768 i
 *   192.168.42.0     172.16.0.2                             0 101 520 2042 i
 *>i                  10.0.1.15                0    100    500 301 520 2042 i
```
Теперь у нас next hop для внешних сетей: 10.0.1.15  - т.е. роутер R15 (а за ним - Ламас).
Т. е. весь трафик пойдёт через Ламас.
смотрим трассировку с VPC1: 

```
VPC1> tracer 192.168.42.1
trace to 192.168.42.1, 8 hops max, press Ctrl+C to stop
 1   192.168.1.2   0.724 ms  0.604 ms  0.655 ms
 2   10.0.1.134   1.011 ms  0.804 ms  0.878 ms
 3   10.0.1.154   1.281 ms  1.131 ms  1.221 ms
 4   172.16.0.14   1.479 ms  1.465 ms  1.405 ms
 5   172.16.0.18   1.617 ms  1.395 ms  1.606 ms
 6   172.16.0.22   1.746 ms  1.645 ms  0.876 ms
 7   *10.20.42.161   0.981 ms (ICMP type:3, code:3, Destination port unreachable)  *

```
Видим, что трафик на офис С-Петербург ушёл через AS 301 (Ламас).

#### 




Начнем настраивать BGP. Начну с роутера  c R14:
```
router bgp 1001
 bgp router-id 10.0.1.14
 network 10.0.1.0 mask 255.255.255.0
 network 10.0.2.0 mask 255.255.255.0
 network 192.168.1.0
 neighbor 10.0.1.15 remote-as 1001
 neighbor 10.0.1.15 update-source Loopback0
 neighbor 172.16.0.2 remote-as 101
```
Итак. Я сделал:
1. назначил явно router-id для процесса BGP.
2. добавил в анонсы сети, которые присутствуют в моей AS. Причем, добавил только "полезные" сети: управления устройствами (адреса Lo) и пользовательские сети (где есть ПК). Сети P2P в анонсы не добавлял. 
Чтобы корректно проанонсились в BGP указанные сети, я создал доп статические маршруты:
```
ip route 10.0.1.0 255.255.255.0 Null0
ip route 10.0.2.0 255.255.255.0 Null0
```
3. Добавил соседей для участия в работе пиринга BGP. В моем случае это: R15 и R22
Важный момент: внутри одной AS я поднял сессию между Lo адресами роутеров.
Чтобы сессия поднялась, нужно, что src пакетов соответсовал Lo. Для этого добавлена команда:
```
 neighbor 10.0.1.15 update-source Loopback0
```
####  Настройка офиса С.-Петербург так, чтобы трафик до любого офиса распределялся по двум линкам одновременно.
Для начала работ посмотрим на таблицу маршрутизации на R18:
```
Gateway of last resort is 0.0.0.0 to network 0.0.0.0

S*    0.0.0.0/0 is directly connected, Null0
      10.0.0.0/8 is variably subnetted, 13 subnets, 4 masks
B        10.0.1.0/24 [20/0] via 172.16.0.21, 20:39:30
B        10.0.2.0/24 [20/0] via 172.16.0.21, 20:39:30
B        10.1.0.22/32 [20/0] via 172.16.0.21, 00:00:30
B        10.3.0.21/32 [20/0] via 172.16.0.21, 00:00:30
B        10.5.2.0/24 [20/0] via 172.16.0.21, 00:00:30
S        10.20.42.0/24 is directly connected, Null0
O        10.20.42.16/32 [110/12] via 10.20.42.161, 22:27:15, Ethernet0/1
C        10.20.42.18/32 is directly connected, Loopback0
O        10.20.42.128/27 [110/12] via 10.20.42.161, 22:26:52, Ethernet0/1
C        10.20.42.160/30 is directly connected, Ethernet0/1
L        10.20.42.162/32 is directly connected, Ethernet0/1
C        10.20.42.164/30 is directly connected, Ethernet0/0
L        10.20.42.166/32 is directly connected, Ethernet0/0
      172.16.0.0/16 is variably subnetted, 6 subnets, 2 masks
B        172.16.0.4/30 [20/0] via 172.16.0.21, 00:00:30
B        172.16.0.8/30 [20/0] via 172.16.0.21, 00:00:30
C        172.16.0.20/30 is directly connected, Ethernet0/2
L        172.16.0.22/32 is directly connected, Ethernet0/2
C        172.16.0.24/30 is directly connected, Ethernet0/3
L        172.16.0.26/32 is directly connected, Ethernet0/3
B     192.168.1.0/24 [20/0] via 172.16.0.21, 20:39:30
O     192.168.42.0/24 [110/11] via 10.20.42.161, 22:46:29, Ethernet0/1
```
Теперь, для того, чтобы забалансировать трафик включим  (на R18):
```
router bgp 2042
 maximum-paths 2
```
Смотрим:
```
Gateway of last resort is 0.0.0.0 to network 0.0.0.0

S*    0.0.0.0/0 is directly connected, Null0
      10.0.0.0/8 is variably subnetted, 13 subnets, 4 masks
B        10.0.1.0/24 [20/0] via 172.16.0.21, 20:40:58
B        10.0.2.0/24 [20/0] via 172.16.0.21, 20:40:58
B        10.1.0.22/32 [20/0] via 172.16.0.25, 00:00:28
                      [20/0] via 172.16.0.21, 00:00:28
B        10.3.0.21/32 [20/0] via 172.16.0.25, 00:00:28
                      [20/0] via 172.16.0.21, 00:00:28
B        10.5.2.0/24 [20/0] via 172.16.0.25, 00:00:28
                     [20/0] via 172.16.0.21, 00:00:28
S        10.20.42.0/24 is directly connected, Null0
O        10.20.42.16/32 [110/12] via 10.20.42.161, 22:28:43, Ethernet0/1
C        10.20.42.18/32 is directly connected, Loopback0
O        10.20.42.128/27 [110/12] via 10.20.42.161, 22:28:20, Ethernet0/1
C        10.20.42.160/30 is directly connected, Ethernet0/1
L        10.20.42.162/32 is directly connected, Ethernet0/1
C        10.20.42.164/30 is directly connected, Ethernet0/0
L        10.20.42.166/32 is directly connected, Ethernet0/0
      172.16.0.0/16 is variably subnetted, 6 subnets, 2 masks
B        172.16.0.4/30 [20/0] via 172.16.0.25, 00:00:28
                       [20/0] via 172.16.0.21, 00:00:28
B        172.16.0.8/30 [20/0] via 172.16.0.25, 00:00:28
                       [20/0] via 172.16.0.21, 00:00:28
C        172.16.0.20/30 is directly connected, Ethernet0/2
L        172.16.0.22/32 is directly connected, Ethernet0/2
C        172.16.0.24/30 is directly connected, Ethernet0/3
L        172.16.0.26/32 is directly connected, Ethernet0/3
B     192.168.1.0/24 [20/0] via 172.16.0.21, 20:40:58
O     192.168.42.0/24 [110/11] via 10.20.42.161, 22:47:57, Ethernet0/1
```
Видим, что на некоторые сети, где совпали as-path и др. параметры - включилась балансоровка трафика. 


#### Конфигурации оборудования.
Готовые конфигурации оборудования были экспортированы в папку configs (zip архив, выгруженный из PnetLab. Так можно?)


